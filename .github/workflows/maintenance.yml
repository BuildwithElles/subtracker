name: Maintenance & Security

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual execution
  push:
    paths:
      - 'package.json'
      - 'package-lock.json'

env:
  NODE_VERSION: '18'

jobs:
  # Dependency audit and security scan
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸ” Run npm audit
        run: |
          echo "ðŸ” Running npm security audit..."
          npm audit --audit-level=moderate || {
            echo "âš ï¸ Found security vulnerabilities!"
            npm audit --audit-level=moderate --json > audit-results.json
            cat audit-results.json
            exit 1
          }
          
      - name: ðŸ“Š Generate security report
        if: failure()
        run: |
          echo "ðŸ“Š Generating security report..."
          npm audit --audit-level=low --json | jq '.' > security-report.json
          
      - name: ðŸ“¤ Upload security report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json
          retention-days: 30

  # Check for outdated dependencies
  dependency-check:
    name: ðŸ“¦ Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸ” Check for outdated packages
        run: |
          echo "ðŸ” Checking for outdated dependencies..."
          npm outdated || true
          
      - name: ðŸ“Š Generate dependency report
        run: |
          echo "ðŸ“Š Generating dependency update report..."
          npm outdated --json > outdated-deps.json || true
          cat outdated-deps.json || echo "No outdated dependencies found"
          
      - name: ðŸ“¤ Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: outdated-deps.json
          retention-days: 30

  # CodeQL security analysis
  codeql-analysis:
    name: ðŸ” CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
      
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]
        
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          
      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3
        
      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # License compliance check
  license-check:
    name: ðŸ“„ License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸ“¥ Install license checker
        run: npm install -g license-checker
        
      - name: ðŸ“„ Check licenses
        run: |
          echo "ðŸ“„ Checking package licenses..."
          license-checker --summary
          license-checker --json > licenses.json
          
      - name: ðŸ“Š Validate license compatibility
        run: |
          echo "ðŸ“Š Validating license compatibility..."
          # Check for problematic licenses
          if license-checker --failOn 'GPL;AGPL;LGPL;CPAL;OSL;EPL;MPL' --summary; then
            echo "âœ… No problematic licenses found"
          else
            echo "âš ï¸ Found potentially problematic licenses"
            exit 1
          fi
          
      - name: ðŸ“¤ Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json
          retention-days: 30

  # Bundle size analysis
  bundle-analysis:
    name: ðŸ“Š Bundle Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          # Use placeholder values for analysis
          VITE_SUPABASE_URL: "https://placeholder.supabase.co"
          VITE_SUPABASE_ANON_KEY: "placeholder-key"
          
      - name: ðŸ“Š Analyze bundle size
        run: |
          echo "ðŸ“Š Analyzing bundle size..."
          du -sh dist/
          find dist -name "*.js" -exec ls -lh {} \; | sort -k5 -hr
          
      - name: ðŸ“ˆ Bundle size report
        run: |
          echo "ðŸ“ˆ Generating bundle size report..."
          TOTAL_SIZE=$(du -sb dist/ | cut -f1)
          TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc)
          echo "Total bundle size: ${TOTAL_SIZE_MB} MB"
          
          # Create simple report
          echo "# Bundle Size Report" > bundle-report.md
          echo "- **Total Size**: ${TOTAL_SIZE_MB} MB" >> bundle-report.md
          echo "- **Generated**: $(date)" >> bundle-report.md
          echo "" >> bundle-report.md
          echo "## File Breakdown:" >> bundle-report.md
          find dist -name "*.js" -exec ls -lh {} \; | sort -k5 -hr | head -10 >> bundle-report.md
          
      - name: ðŸ“¤ Upload bundle report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-report
          path: bundle-report.md
          retention-days: 30

  # Create maintenance summary
  maintenance-summary:
    name: ðŸ“‹ Maintenance Summary
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-check, license-check, bundle-analysis]
    if: always()
    
    steps:
      - name: ðŸ“‹ Create maintenance summary
        run: |
          echo "ðŸ“‹ Creating maintenance summary..."
          
          echo "# ðŸ”§ Weekly Maintenance Report" > maintenance-summary.md
          echo "**Generated**: $(date)" >> maintenance-summary.md
          echo "" >> maintenance-summary.md
          
          echo "## ðŸ”’ Security Status" >> maintenance-summary.md
          if [ "${{ needs.security-audit.result }}" == "success" ]; then
            echo "âœ… Security audit passed - no vulnerabilities found" >> maintenance-summary.md
          else
            echo "âš ï¸ Security audit found issues - review required" >> maintenance-summary.md
          fi
          echo "" >> maintenance-summary.md
          
          echo "## ðŸ“¦ Dependencies" >> maintenance-summary.md
          if [ "${{ needs.dependency-check.result }}" == "success" ]; then
            echo "âœ… Dependency check completed" >> maintenance-summary.md
          else
            echo "âš ï¸ Dependency check found issues" >> maintenance-summary.md
          fi
          echo "" >> maintenance-summary.md
          
          echo "## ðŸ“„ License Compliance" >> maintenance-summary.md
          if [ "${{ needs.license-check.result }}" == "success" ]; then
            echo "âœ… All licenses are compliant" >> maintenance-summary.md
          else
            echo "âš ï¸ License compliance issues found" >> maintenance-summary.md
          fi
          echo "" >> maintenance-summary.md
          
          echo "## ðŸ“Š Bundle Analysis" >> maintenance-summary.md
          if [ "${{ needs.bundle-analysis.result }}" == "success" ]; then
            echo "âœ… Bundle analysis completed successfully" >> maintenance-summary.md
          else
            echo "âš ï¸ Bundle analysis encountered issues" >> maintenance-summary.md
          fi
          
          cat maintenance-summary.md
          
      - name: ðŸ“¤ Upload maintenance summary
        uses: actions/upload-artifact@v4
        with:
          name: maintenance-summary
          path: maintenance-summary.md
          retention-days: 90
